---
title: Proc を使って AppEngine の JRuby でセーフレベルを変更する
date: 2010-06-05T00:00:00.000Z
lastmod: 2010-06-05T08:30:39.000Z
draft: false
tags:
  - tDiary
  - Ruby
---

[tDiary を Google App Engine で動かしてみた](/posts/20100529/p01)の続き。 前回までのまとめ。

- tDiary のセキュアモードはプラグインを $SAFE = 4 で実行する (参考: [\[tDiary-devel\] Re: Pluginをどこまで信用すべきなのか](http://www.tdiary.org/archive/devel/msg00690.html))
- セーフレベルの変更には Thread を使っている
- AppEngine はスレッドに対応していないので、とりあえずセーフレベルを変更しないようにして逃げた

なかださんから、[SAFEレベルの変更はprocでもできませんか](https://www.machu.jp/diary/20100529.html#c01)というツッコミをいただいたので、。 Thread の代わりに Proc を使うように修正した。

#### 既存コードのテストを書く

といっても、いきなりコードを修正するのではなく、まずは Thread を使った版のテストコードを書く。

まずは tdiary.rb から Safe モジュールのコードを切り出して safe.rb として保存する。

[gist:426433](http://gist.github.com/426433)

つぎに、 safe.rb に対するテストコード safe_spec.rb を書く。 セーフレベル1だと環境変数を変更できるが、セーフレベル4だと SecurityError 例外が発生することを確認している。

[gist:426434](http://gist.github.com/426434)

spec コマンドでテストを実行し、正常に終了することを確認する。

```
$ spec safe_spec.rb
..

Finished in 0.003902 seconds

2 examples, 0 failures
```

#### コードを修正 (Thread から Procに)

Thread の代わりに Proc を使うように safe.rb を修正する。

[gist:426435](http://gist.github.com/426435)

修正したコードでもう一度 spec コマンドを実行する。

```
$ spec safe_spec.rb
..

Finished in 0.003902 seconds

2 examples, 0 failures
```

これで Thread でなく Proc でも同じように動くことが確認できた。

#### GitHub に反映

この修正コードを testable ブランチに反映し、 [appengine ブランチにマージ](http://github.com/machu/tdiary-core/commit/5c4013bd21328d32c618a83728dad8c5a0fae6cc)しておしまい。
