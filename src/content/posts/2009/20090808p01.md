---
title: tDiary 高速化パッチを当ててみた
date: 2009-08-08T00:00:00.000Z
lastmod: 2009-08-09T15:41:42.000Z
draft: false
tags:
  - tDiary
---

tDiary-devel メーリングリストで、かずひこさんが ~~ヒダイアリー~~ tDiary の高速化パッチを提案されてる。

* [\[tDiary-devel\] all\_filtersとかload\_pluginsが呼ばれ過ぎで遅い件](http://sourceforge.net/mailarchive/forum.php?thread_name=4A781784.9030500%40fdiary.net\&forum_name=tdiary-devel)

> tDiaryのプロファイルをとってみると、やっぱりeval系でけっこう時間がかかっていて、だったらevalの数を減らせばいいじゃない！と思って追いかけているうちに、1アクセスにつき4回もall\_filtersが呼ばれているのに気づきました。

> この変更をすれば、Plugin.newが呼ばれる回数が1回だけになって、ruby-1.8、ruby-1.9ともに、60-70%ほど速く！！動くようになりました。これは、先日までのruby-1.8より、この変更をしたruby-1.9の方が1割以上速く動く程度の差です

さっそく、 Ruby1.9.1 で動かしているこの日記でもパッチを適用してみた。 （今はパッチが本体に取り込まれているので、 svn update するだけで適用できる）

ab コマンドでの結果は以下の通り。

```
$ ab -n3 -c2 http://www.machu.jp/diary/
```

|         |             |             |
| ------- | ----------- | ----------- |
| パラメータ   | 適用前         | 適用後         |
| テスト時間   | 3.69秒       | 2.51秒       |
| スループット  | 0.81req/sec | 1.19req/sec |
| リクエスト時間 | 1231msec    | 837msec     |

処理時間にして、およそ32%短縮されているみたい。 これはいいね。
