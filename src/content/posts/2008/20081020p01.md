---
title: Ruby を使って Flickr へ写真をアップロード
date: 2008-10-20T00:00:00.000Z
lastmod: 2008-10-20T15:02:32.000Z
draft: false
tags:
  - tDiary
  - Ruby
  - Flickr
---

[image\_ex.rbを使っていた日記をflickr.rbを使うように書き換える](http://www.snest.net/diary/20081019.html#p01)というのが自動的にできるといいなと思って[ブクマ](http://b.hatena.ne.jp/kmachu/20081020#bookmark-10476354)したら、[まちゅさんがimage\_ex.rbからflickr.rbへのマイグレーションツールを作ってくれるかも](http://www.snest.net/diary/20081020.html#p01)という流れに。

ということで、 image\_ex から flickr への移行について考えてみた。

#### 移行対象の写真ファイルを取得

image, image\_ex プラグインは images/ ディレクトリに yyyymmdd\_i.jpg 形式でファイルを配置している。 2008年10月20日の日記の写真なら、 20081020\_0.jpg になる。2枚目以降は i の数値が増えていく。 image\_ex プラグインは写真を縮小する機能があり、縮小したファイルは（おそらく）名前の先頭に「s」が付く。 Flickrへ移行するときは、 images/yyyymmdd\_i.jpg 形式のファイルを取得すればよさそう。

#### 写真を Flickr へアップロード

tDiary の Flickr プラグインは日記に写真を表示することができるけど、認証が必要なアップロードには対応していない。 自作で認証やアップロードに対応するのは大変なので、ライブラリを使う方向で調べてみた。

* [flickr.rb](http://rubyforge.org/projects/flickr/) … 最終更新日が2008年の2月。使いやすそうなライブラリだけど、認証やアップロードに対応していなかったので残念ながらNG。 gem install flickr でインストール可能。
* [WWW::MechanizeでFlickrに画像をアップロードする](http://d.hatena.ne.jp/x68kace/20080429/p2) … Webブラウザの動作をエミュレートする方法。悪くないけどFlickrの仕様変更の影響を受けるので最後の手段。
* [rflickr.rb](http://rubyforge.org/projects/rflickr/) … 最終更新日が2006年の1月。もう活動していないのかな。認証とアップロードに対応している。

試しに、 rflickr.rb を使ってみた。 RubyGemsを使ってインストール。

```
sudo gem install rflickr
```

同梱の GETTING-STARTED を参考に、以下のサンプルソースを作成した。 gem の使い方に自信ないけど、大丈夫かな？

```
#!/usr/bin/env ruby
require 'rubygems'
gem 'rflickr'
require 'flickr'

api_key = '******************************'
secret = '*********'
flickr = Flickr.new('flickr.dat', api_key, secret)
# トークンを取得していなければ取得する。トークンは flickr.dat に格納する。
unless flickr.auth.token
  url = flickr.auth.login_link                                               
  puts "Webブラウザで #{url} へアクセスしてから、何かキーを押してください"
  gets
  flickr.auth.getToken
  flickr.auth.cache_token
end
# 写真をアップロード。返り値は写真のID。
p flickr.photos.upload.upload_file(ARGV.shift)
```

[Flickr のサイト](http://www.flickr.com/services/api/keys/)で api\_key と secret を取得し、ファイルに設定する。 また、APIの Auth mode は Web ではなく Desktop にしておく。 このサンプルをコマンドラインから実行すると、引数で渡したJPEGファイルがFlickrにアップデートされた。

```
./rflickr_test.rb sample.jpg
```

同時に、取得したトークンが flickr.dat に保存される。 これで、2回目からはトークンの取得が不要になる。

```
<auth>
  <token>******************-******************</token>
  <perms>delete</perms>
  <user nsid="19594487@N00" username="machu." fullname="MATSUOKA Kohei" />
</auth>
```

upload\_file メソッドは lib/flickr/upload.rb に定義されている。 引数でタイトルなどを指定することもできる。

```
def upload_file(filename,title=nil,description=nil,tags=nil,
      is_public=nil,is_friend=nil,is_family=nil)
```

あとは、 image プラグインの写真 (images/yyyymmdd\_i.jpg) をアップロードし、ファイル名と Flickr の写真IDのペアを保存すればOKかな。

#### imageプラグインの書き換え

日記データに記録されている image プラグインの呼び出しを flickr プラグインに変更する。 このとき、先ほど保存したファイル名と Flickr のIDのペアが必要になる。 書き換えの案は2つ。

1. 日記データ（\*.td2）の image プラグインの呼び出し文字列を書き換える
2. flickr プラグインにて image メソッドを上書きする

1の案は関係ない文字を書き換えてしまいそうで怖い。 2の案のほうが安全だけど、いつまでもファイル名とIDのペアが必要なのが欠点か。 うーん。

#### P.S.

僕も昔は絵日記プラグイン (image.rb, image-ex.rb) を使っていたんだけど、どこかのタイミングで images/ ディレクトリを消してしまっていたみたい。 昔の日記を表示しても写真が表示されないや。 なんてこった。
