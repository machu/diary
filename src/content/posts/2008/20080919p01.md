---
title: CPIのVPSが使えるようになった
date: 2008-09-19T00:00:00.000Z
lastmod: 2008-09-19T03:41:41.000Z
draft: false
tags:
  - cpi
---

[CPI の VPS に申し込ん](/posts/20080916/p02)でから2日。 サーバ設定が完了したという連絡がきたので、ワクワクしながら使ってみた。 自由に使えるサーバは今は亡きVPS7以来だよ。

#### おさらい

- [CPIのVPSサーバ](http://www.scalable.jp/index.html)は仮想化を使ったVPSサーバ
- root権限がもらえるので、普通のレンタルサーバとは自由度が段違い
- 1年契約だと1,890円/月。さくらのプレミアム＋αくらいのお値段

#### 第一印象

- かなり軽快に動く。まだ利用者が少ないから？
- 初期状態ではメモリ5MB, ディスク36.5MBを消費。動作プロセスは7個くらい。
- 仮想化には~~Parallels~~ Parallels Virtuozzo を使っている。Webブラウザから管理コンソールに接続できる。 ← [Parallelsだと誤解を招く](http://b.hatena.ne.jp/dk19810313/20080919#bookmark-10071783)と指摘をいただきました
  - サーバのリソースを確認したり、シャットダウンしたり、パッケージをインストールしたりできる。

管理画面はこんな感じ。これはインストールされているパッケージを表示したところ。

[![Parallels Power Panel](https://farm4.staticflickr.com/3233/2866973597_decc831e07_m.jpg "Parallels Power Panel")](http://www.flickr.com/photos/machu/2866973597/)

#### 初期セットアップ

最初はrootでのログインになる。 そのままじゃ危ないので、まずは基本的なセットアップから。

作業用のユーザを作る。sudoを使いたいのでwheelグループに参加させる。

```
#  useradd -u 100 -g users -G wheel -m machu
#  passwd machu
```

visudo を実行して wheel グループに sudo 権限を付与する。

```
# visudo
%wheel  ALL=(ALL)       ALL
```

ここまでできたら root から作業ユーザ (machu) へスイッチ。

#### sshd の設定

インターネットに公開されているサーバなので、パスワードでログインできる状態のままじゃ怖すぎる。 なので、sshdの設定を変更して、パスワードでのログインを禁止（公開鍵のみでのログイン）にする。

まずは作業ユーザで .ssh/authorized_keys に自分の公開鍵を設定する。 公開鍵を持っていない場合の作り方は、この日記を ssh で検索すると出てくると思う。

```
$ mkdir .ssh
$ vi .ssh/authorized_keys
```

次に sshd_config を編集する。

```
$ cd /etc/ssh
$ sudo cp -p sshd_config sshd_config.org
$ sudo vi sshd_config
```

差分は以下の通り。 rootでのログインと、パスワードでのログインを禁止している。

```
--- sshd_config.org     2008-09-02 19:54:44.000000000 +0900
+++ sshd_config 2008-09-18 20:56:53.000000000 +0900
@@ -36,13 +36,13 @@
 # Authentication:

 #LoginGraceTime 2m
-#PermitRootLogin yes
+PermitRootLogin no
 #StrictModes yes
 #MaxAuthTries 6

 #RSAAuthentication yes
-#PubkeyAuthentication yes
-#AuthorizedKeysFile    .ssh/authorized_keys
+PubkeyAuthentication yes
+AuthorizedKeysFile     .ssh/authorized_keys

 # For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
 #RhostsRSAAuthentication no
@@ -57,7 +57,7 @@
 # To disable tunneled clear text passwords, change to no here!
 #PasswordAuthentication yes
 #PermitEmptyPasswords no
-PasswordAuthentication yes
+PasswordAuthentication no

 # Change to no to disable s/key passwords
 #ChallengeResponseAuthentication yes
```

そのあとはWebの管理ツールからPHPやRubyやzshなんかのパッケージをインストールした。 メモリとの勝負だけど、OSの管理ができる人なら、VPSを使ってみるのも面白いと思うよ。

とりあえず、来月で契約が切れる joyent (旧TextDrive) は解約決定。 1ヶ月かけて wolfbbs.jp と capping.machu.jp のコンテンツを移動する。
