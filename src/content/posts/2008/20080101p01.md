---
title: Rails 2.0 の Cookie と、 RESTful でのセッション管理について
date: 2008-01-01T00:00:00.000Z
lastmod: 2008-01-03T14:58:38.000Z
draft: false
tags:
  - Rails
  - Security
---

Rails 2.0 になってセッション Cookie の持ち方が変わった。 1.2 までは Cookie にセッション ID を書き込んで、対応するセッション情報をメモリ上に持っていたけど、 2.0 だと Cookie にそのままセッション情報を書き込むようになってる。 こうすると、アプリケーションサーバを分散させたときにセッション情報をシェアしなくてよくなる。 もちろん、 Cookie の中身はユーザが簡単に書き換えられるから、書き換えを検出するために HMAC をつけている。

んで、この方法でのセッションの持ち回りに落とし穴はないのかなぁ…と思って Twitter でつぶやいたら、意外と話が広がって面白かったのでここでまとめてみるよ。

> [machu](http://twitter.com/machu/statuses/546452362) Rails2.0 の Cookie 側にセッション情報を持つ方法だと、セッションタイムアウトはどうやるんだろ。自作かなぁ。

> [takahashim](http://twitter.com/takahashim/statuses/546457872) @machu タイムアウトというか、生成時刻も含めてやればサーバ側で好きなタイミングで reject できるはずでは。ユーザが自由に書き換えられないのがポイントなので。

> [machu](http://twitter.com/machu/statuses/546490132) @takahashim やっぱりコントローラでフィルタするコードを書くようになるんですね。

> [takahashim](http://twitter.com/takahashim/statuses/546457872) @machu flash 文字列ならそもそもタイムアウトは気にしなくてもいいような気もしますが、セッション保持用はタイムアウトさせといた方が安全でしょうし、そうするとコントローラではじくべきかなあ、と。

> [machu](http://twitter.com/machu/statuses/546513262) @takahashim はい。セッション保持のことを気にしていました。何も考慮しないと 1 年前の Cookie でログインできそうなので。

> [takahashim](http://twitter.com/takahashim/statuses/546531552) RESTful に考えるなら、セッション情報を保持するのではなく、 ID とパスワードを毎回送りつけるべきなんですよね。これが大前提]]

> [takahashim](http://twitter.com/takahashim/statuses/546557232) ただ、 ID とパスワードを送るのはいろいろ問題があるので、代わりにトークンを使うことができるようにする。その場合、トークンは期限つきの ID+ パスワードの代替物となる。

> [takahashim](http://twitter.com/takahashim/statuses/546561562) その期限が一回きりなのが Digest 認証だったり WSSE 認証で、時間単位で続くのがいわゆるクッキーを使ったセッション管理、……という認識でいいのかなあ。

> [takahashim](http://twitter.com/takahashim/statuses/546564842) 『 RESTful Web サービス』では 6.1.2 と 8.14.1 に書いてあるっぽい（まだ読了してない）

※ (追記) RESTful Web サービスを読んだら「8.17 ユーザはなぜ HTTP クライアントを信頼するのか」にも面白い議論が書かれていた

> [machu](http://twitter.com/machu/statuses/546536062) @takahashim たしかに。でもそうなると「重要な操作の前にパスワード入力」ができなくなりますね。

> [takahashim](http://twitter.com/takahashim/statuses/546568052) @machu 「重要な操作の前にパスワード入力」って amazon みたいな方法ですか？

> [machu](http://twitter.com/machu/statuses/546578522) @takahashim はい。そうです。パスワード変更時は他のサイトもそうですね。

> [takahashim](http://twitter.com/takahashim/statuses/546654212) @machu 再入力の問題は、 Web サービスのクライアントとサーバの間の問題ではなく、クライアントと人間（ユーザ）の間の問題じゃないかという気がしてきました。だもんで、 Web サービスのアーキテクチャとは直接的には関係のないことじゃないかと。

> [machu](http://twitter.com/machu/statuses/546665122) @takahashim REST の視点からはそうですね。でもセッション漏洩時の被害減少のためにはサーバ側でのチェックが必須だと思います。

> [machu](http://twitter.com/machu/statuses/546665862) アーキテクチャの美しさとセキュリティはトレードオフなのかなぁ。

> [takahachim](http://twitter.com/takahashim/statuses/546711352) @machu ふつうのセッション漏洩時の話については、おそらくトークンで、ということになると思います。 amazon みたいな再入力はまた別の話っぽい気がします。

> [machu](http://twitter.com/machu/statuses/546737492) @takahashim セッション漏洩対策のために再入力すると思っていたのですが、別の話というのがちょっと分からなかったです。

> [takahachim](http://twitter.com/takahashim/statuses/546751222) @machu 例えば amazon などの場合、離席時に勝手に購入したりしないように、というのもあると思います。そもそもセッション保持期間が長すぎなので。

> [machu](http://twitter.com/machu/statuses/546763462) @takahashim 理解しました。僕は離席問題とセッション漏洩はサーバ側から見たら同じと考えてました。 Windows のパスワードロックと同じですね。

> [machu](http://twitter.com/machu/statuses/546773142) @takahashim Windows のロックに頼るならトークン使わずに SSL+Basic 認証でよさそうです。

> [machu](http://twitter.com/machu/statuses/546777132) んーでも、ログイン後は SSL を使わないからせめてトークンなのかな。

> [machu](http://twitter.com/machu/statuses/546787432) そもそもなんで漏洩しやすい Cookie でセッション管理するんだっけ。 HTTP 認証のほうが漏洩しずらいのに。

> [tokuhirom](http://twitter.com/tokuhirom/statuses/546797902) @machu ログアウトできないというのが致命的な欠陥だったり……

> [machu](http://twitter.com/machu/statuses/546798792) HTTP 認証でログアウト処理 <http://tinyurl.com/2xrdul>

> [tokuhirom](http://twitter.com/tokuhirom/statuses/546805332) @machu ログイン画面がカスタマイズできないのが嫌というお客さんもいますね

> [machu](http://twitter.com/machu/statuses/546803922) @tokuhirom ログイン画面が分かりにくいって理由もあった気がします。

> [machu](http://twitter.com/machu/statuses/546809402) @tokuhirom 見事にかぶったｗ

> [machu](http://twitter.com/machu/statuses/546811652) HTML フォームに入れたパスワードを HTTP ヘッダで送る仕組みがあれば OK ？

> [machu](http://twitter.com/machu/statuses/546815882) CGI だと HTTP 認証を制御できないからという話もあったような。

> [machu](http://twitter.com/machu/statuses/546833172) REST 本を読むときはこの辺の話を考えるようにしようっと。

> [machu](http://twitter.com/machu/statuses/546833642) Rails のセッションから話が広がって面白かった。

> [machu](http://twitter.com/machu/statuses/546837122) JavaScript から HTTP 認証ヘッダを制御できないのはなんでだろ？（ XHR を除く）

> [machu](http://twitter.com/machu/statuses/546838212) JS から HTTP 認証ヘッダを読めちゃダメだけど、設定できるようになってればいいのに。

> [takahashim](http://twitter.com/takahashim/statuses/546881702) @machu ブラウザのセキュリティモデルとして、ユーザの明示的な操作なしに勝手に認証情報が書き換わってしまうのは何か危険な気もします……あんまり深い考えではないですが。

> [takahashim](http://twitter.com/takahashim/statuses/548098322) CSRF 対策してあるサイト ( クッキーとは別にトークン利用とか ) に対しても、 iframe でトークン抜き出して JavaScript でそのトークンを利用して自動 POST 、みたいな攻撃ってできないんでしたっけ？

最後はなんだか RESTful 設計でのセッションの持ち方 (REST はステートレスなのでこの概念がすでに変かも？) という話になった。 Cookie でセッション管理するのが当たり前だと思っていたけど、 XSS 脆弱性の影響を受けない HTTP 認証を使った方が安全だよなぁ。
