---
title: base_url の設定プラグイン (もどき)
date: 2007-07-27T00:00:00.000Z
lastmod: 2007-07-27T12:58:42.000Z
draft: false
tags:
  - tDiary
---

[tDiaryの脆弱性に関する報告(2007-07-23)](http://sho.tdiary.net/20070723.html#p01)を受けての[今なら conf.base\_url を設定画面から変更できるようにするパッチを書くと…](http://www.hsbt.org/diary/20070724.html#p03)という話。

とはいえ、 base\_url をわざわざ設定するのは面倒。 問題は base\_url 中の SERVER\_NAME が書き換えられるということなので、以下のようにしてみた。

* 日記の設置者が設定画面を開く
* 設定画面の SERVER\_NAME を選択し、内容を確認して OK ボタンをクリックする
* その時の SERVER\_NAME が tdiary.conf に保存される
* 日記の閲覧時に、 SERVER\_NAME を保存した値に書き換える

```
add_conf_proc('server_name', 'SERVER_NAME') do
  if @mode == 'saveconf'
    @conf['server_name'] = ENV['SERVER_NAME']
    "Thank you."
  else
    "SERVER_NAME is #{ENV['SERVER_NAME']}. If correct, please press 'OK'"
  end
end

@conf.instance_eval { alias :base_url_org :base_url }
def @conf.base_url
  base_url_org.gsub(%r|(https?://)([^:/]+)|, "\\1#{self['server_name']}")
end
```

正規表現はちょっと自信ない。 本当は update.rb から index.rb の base\_url が取得できるといいんだけど。 @index は相対パスっぽいからなぁ。
